#!/bin/bash
# sk8 - package manager for rollerblades (https://github.com/chr1573r/rollerblades)

# Sanitize package name to prevent path traversal attacks
sanitize_package_name() {
  local pkg="$1"

  # Reject empty package names
  if [[ -z "$pkg" ]]; then
    echo "Error: Package name cannot be empty." >&2
    return 1
  fi

  # Only allow alphanumeric, dash, underscore, and dot (not at start)
  # Reject any path traversal attempts
  if [[ "$pkg" =~ ^[a-zA-Z0-9][a-zA-Z0-9._-]*$ ]] && [[ ! "$pkg" =~ \.\. ]]; then
    echo "$pkg"
    return 0
  else
    echo "Error: Invalid package name '$pkg'. Names must start with alphanumeric and contain only alphanumeric, dash, underscore, or dot." >&2
    return 1
  fi
}

# Clean up cached files for a package
cleanup_cache() {
  local pkg="$1"
  rm -f "$SK8_DIR/cache/${pkg}.tar.gz" "$SK8_DIR/cache/${pkg}.signature"
}

# Function to load configuration from file or set default values
load_config() {

  if [[ -z "$SK8_DIR" ]]; then
    SK8_DIR="$HOME/.sk8"
  fi

  if ! [[ -d "$SK8_DIR" ]]; then
    echo "Setup: Initializing sk8 dir '$SK8_DIR'"
    mkdir -p "$SK8_DIR"
  fi

  if ! [[ -d "$SK8_DIR" ]]; then
    echo "Error: Cannot access sk8 dir '$SK8_DIR'"
    exit 1
  fi

  if ! [[ -d "$SK8_DIR/cache" ]]; then
    echo "Setup: Initializing cache dir in '$SK8_DIR'"
    mkdir -p "$SK8_DIR/cache"
  fi

  if ! [[ -d "$SK8_DIR/package" ]]; then
    echo "Setup: Initializing package dir in '$SK8_DIR'"
    mkdir -p "$SK8_DIR/package"
  fi

  if [[ -f "$SK8_DIR/config" ]]; then
    source "$SK8_DIR/config"
  else
    echo "Warning: sk8 config could not be loaded, using defaults"
    # Default values
    #PATH_FILE="$HOME/.bashrc"
  fi

  if [[ -z "$SK8_RB_URL" ]]; then
    echo "Error: Rollerblades url not set. Aborting"
    exit 1
  fi

  if ! [[ -f "$SK8_DIR/cache/rollerblades.pub" ]]; then
    echo "Setup: Downloading a local copy of rb repo public key..."
    dl rollerblades.pub || {
    echo "Error: Failed to download repo public key for package verification."
    exit 1
    }
  fi

} 

# Curl wrapper for any download activity
dl(){
  echo "Downloading '$1'"

  curl -sSf --connect-timeout 30 --max-time 300 "${SK8_RB_URL}/$1" -o "$SK8_DIR/cache/$1" || {
    echo "Error: Failed to download '${SK8_RB_URL}/$1'"
    rm -f "$SK8_DIR/cache/$1"
    return 1
  }
}

# Function to verify package integrity
verify_package() {
  local package="$1"

  echo "Verifying package $package..."
  dl "$package.signature" || {
    echo "Error: Failed to download package signature for $package."
    return 1
  }

  # Verify signature using SHA256 (matching rollerblades signing algorithm)
  if openssl dgst -sha256 -verify "$SK8_DIR/cache/rollerblades.pub" -signature "$SK8_DIR/cache/$package.signature" "$SK8_DIR/cache/$package.tar.gz" >/dev/null; then
    echo "Package $package verified successfully."
    return 0
  else
    echo "Error: Package $package signature verification failed."
    return 1
  fi
}

# Function to install a package
install_package() {
  package=$(sanitize_package_name "$1") || return 1

  if [[ -d "$SK8_DIR/package/$package" ]]; then
    echo "Package '$package' is already installed."
    return 0
  fi

  echo "Installing $package..."
  mkdir -p "$SK8_DIR/package/$package"
  dl "$package.tar.gz" || {
    echo "Error: Failed to download package '$package'."
    rm -rf "$SK8_DIR/package/$package"
    return 1
  }

  verify_package "$package" || {
    echo "Error: Failed to verify package '$package'."
    cleanup_cache "$package"
    rm -rf "$SK8_DIR/package/$package"
    return 1
  }

  tar -xz --no-same-owner -C "$SK8_DIR/package/$package" -f "$SK8_DIR/cache/$package.tar.gz" || {
    echo "Error: Failed to extract package '$package'."
    cleanup_cache "$package"
    rm -rf "$SK8_DIR/package/$package"
    return 1
  }

  cleanup_cache "$package"
  echo "'$package' has been installed in '$SK8_DIR/package/$package'"
}

# Function to remove a package
remove_package() {
  if [[ -z "$1" ]]; then
    echo "Error: No package specified."
    return 1
  fi
  package=$(sanitize_package_name "$1") || return 1

  if [[ ! -d "$SK8_DIR/package/$package" ]]; then
    echo "Package $package is not installed."
    return 1
  fi

  echo "Removing $package..."
  rm -rf "${SK8_DIR}/package/${package}" || {
    echo "Error: Failed to remove $package."
    return 1
  }

  echo "$package has been removed."
}

# Function to upgrade a package
upgrade_package() {
  if [[ -z "$1" ]]; then
    echo "Error: No package specified."
    return 1
  fi
  package=$(sanitize_package_name "$1") || return 1

  if [[ ! -d "$SK8_DIR/package/$package" ]]; then
    echo "Package $package is not installed."
    return 1
  fi

  echo "Upgrading $package..."

  dl "$package.tar.gz" || {
    echo "Error: Failed to download package $package."
    return 1
  }

  verify_package "$package" || {
    echo "Error: Failed to verify package $package."
    cleanup_cache "$package"
    return 1
  }

  tar -xz --no-same-owner -C "$SK8_DIR/package/$package" -f "$SK8_DIR/cache/$package.tar.gz" || {
    echo "Error: Failed to extract package $package."
    cleanup_cache "$package"
    return 1
  }

  cleanup_cache "$package"
  echo "$package has been upgraded."
}

# Upgrade all installed packages
upgrade_all() {
  local pkg_dir="$SK8_DIR/package"
  local upgraded=0
  local failed=0

  if [[ ! -d "$pkg_dir" ]] || [[ -z "$(ls -A "$pkg_dir" 2>/dev/null)" ]]; then
    echo "No packages installed."
    return 0
  fi

  echo "Upgrading all installed packages..."
  for pkg_path in "$pkg_dir"/*; do
    if [[ -d "$pkg_path" ]]; then
      local pkg
      pkg=$(basename "$pkg_path")
      if upgrade_package "$pkg"; then
        ((upgraded++))
      else
        ((failed++))
      fi
    fi
  done

  echo "Upgrade complete: $upgraded succeeded, $failed failed."
}

# Fetch package index from server
fetch_index() {
  echo "Fetching package index..."
  dl "packages.txt" || {
    echo "Error: Failed to fetch package index."
    return 1
  }
  echo "Package index updated."
}

# List available packages from index
list_available() {
  local index="$SK8_DIR/cache/packages.txt"

  if [[ ! -f "$index" ]]; then
    echo "Package index not found. Run 'sk8 update' first."
    return 1
  fi

  echo "Available packages:"
  while IFS= read -r pkg; do
    # Skip empty lines and comments
    [[ -z "$pkg" || "$pkg" =~ ^# ]] && continue

    # Check if installed
    if [[ -d "$SK8_DIR/package/$pkg" ]]; then
      echo "  $pkg [installed]"
    else
      echo "  $pkg"
    fi
  done < "$index"
}

# List installed packages
list_installed() {
  local pkg_dir="$SK8_DIR/package"

  if [[ ! -d "$pkg_dir" ]] || [[ -z "$(ls -A "$pkg_dir" 2>/dev/null)" ]]; then
    echo "No packages installed."
    return 0
  fi

  echo "Installed packages:"
  for pkg_path in "$pkg_dir"/*; do
    if [[ -d "$pkg_path" ]]; then
      echo "  $(basename "$pkg_path")"
    fi
  done
}

# Main script
load_config

case "$1" in
  install)
    install_package "$2"
    ;;
  remove|uninstall)
    remove_package "$2"
    ;;
  update)
    # apt-style: update refreshes the package index
    fetch_index
    ;;
  upgrade)
    # apt-style: upgrade updates packages
    if [[ -n "$2" ]]; then
      upgrade_package "$2"
    else
      upgrade_all
    fi
    ;;
  reinstall|force-install|re-install)
    remove_package "$2"
    install_package "$2"
    ;;
  list)
    case "$2" in
      --installed|-i)
        list_installed
        ;;
      "")
        list_available
        ;;
      *)
        echo "Usage: sk8 list [--installed]"
        exit 1
        ;;
    esac
    ;;
  *)
    echo "Usage: sk8 <command> [package_name]"
    echo ""
    echo "Commands:"
    echo "  install <pkg>     Install a package"
    echo "  remove <pkg>      Remove a package"
    echo "  reinstall <pkg>   Remove and reinstall a package"
    echo "  update            Fetch latest package index"
    echo "  upgrade [pkg]     Upgrade all packages or a specific package"
    echo "  list              List available packages"
    echo "  list --installed  List installed packages"
    exit 1
    ;;
esac

